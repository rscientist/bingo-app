<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bingo 000–999</title>
  <style>
    :root { --accent: #ffcc00; --ok: #2e7d32; --warn: #d32f2f; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, Arial, sans-serif; background: #f6f7fb; color: #222; }
    header { background: var(--accent); padding: 12px; text-align: center; }
    h1 { margin: 0; font-size: 22px; }
    .prices { display: flex; gap: 16px; justify-content: center; font-weight: 600; margin-top: 6px; }
    main { max-width: 1100px; margin: 0 auto; padding: 12px; }
    .controls { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 10px; }
    .controls button { padding: 10px 14px; border: 0; border-radius: 12px; background: var(--accent); font-weight: 700; cursor: pointer; }
    .controls .secondary { background: #e0e0e0; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 6px; }
    .cell { background: white; border: 1px solid #ddd; border-radius: 12px; padding: 10px 0; text-align: center; font-weight: 700; cursor: pointer; user-select: none; transition: transform 0.05s ease, background 0.2s; }
    .cell:hover { transform: translateY(-1px); }
    .cell.selected { background: #c8e6c9; border-color: #9ccc9c; }
    .cell.reserved { background: #fff3cd; border-color: #ffe082; color: #8d6e63; cursor: not-allowed; }
    .cell.sold { background: #ffcdd2; border-color: #ef9a9a; color: #b71c1c; cursor: not-allowed; }
    .selection { margin-top: 10px; padding: 10px; background: white; border: 1px solid #eee; border-radius: 12px; }
    #selectedList { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    /* Modal */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.55); display: flex; align-items: center; justify-content: center; }
    .hidden { display: none; }
    .modal-content { background: white; width: min(560px, 92vw); border-radius: 16px; padding: 18px; position: relative; }
    .close { position: absolute; right: 12px; top: 6px; font-size: 28px; cursor: pointer; }
    .kv { display: grid; grid-template-columns: 140px 1fr; gap: 6px; margin-top: 10px; font-family: ui-monospace, Menlo, monospace; }
    .qrBox { border: 2px dashed #bbb; border-radius: 12px; padding: 10px; text-align: center; }
    .note { margin-top: 8px; font-size: 14px; color: #555; }
    .countdown { margin-top: 10px; font-weight: 700; color: #333; }
    .field { display: flex; flex-direction: column; gap: 4px; }
    .field label { font-size: 14px; }
    .field input { padding: 8px 10px; border: 1px solid #ccc; border-radius: 10px; }
    .radio-row { display: flex; gap: 12px; }
    .btn { padding: 10px 14px; border: 0; border-radius: 12px; background: var(--accent); font-weight: 700; cursor: pointer; }
    .btn.secondary { background: #e0e0e0; }
  </style>
</head>
<body>
  <header>
    <h1>Bingo 000–999</h1>
    <div class="prices">
      <span>Nequi: $20.000 COP</span>
      <span>Pix: R$30,00 BRL</span>
      <span>Zelle: $5 USD</span>
    </div>
  </header>

  <main>
    <div class="controls">
      <button id="choosePayBtn">Choose payment</button>
      <button id="clearSelectionBtn" class="secondary">Clear selection</button>
    </div>

    <div id="grid" class="grid"></div>

    <div class="selection">
      <h3>Selected:</h3>
      <div id="selectedList">None</div>
    </div>
  </main>

  <!-- Payment Method + Buyer Info Modal -->
  <div id="payerModal" class="modal hidden">
    <div class="modal-content">
      <span id="payerClose" class="close">×</span>
      <h2>Checkout</h2>
      <div class="kv">
        <div>Numbers:</div><div id="payerNums">–</div>
      </div>
      <div style="margin-top:10px; display:grid; gap:10px;">
        <div class="field">
          <label for="firstName">First Name / Nombre / Nome</label>
          <input id="firstName" placeholder="e.g., Juan / João" />
        </div>
        <div class="field">
          <label for="lastName">Last Name / Apellido / Sobrenome</label>
          <input id="lastName" placeholder="e.g., Pérez / Silva" />
        </div>
        <div class="field">
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="you@example.com" />
        </div>
        <div class="field">
          <label>Payment method</label>
          <div class="radio-row">
            <label><input type="radio" name="paymethod" value="nequi" checked /> Nequi (COP 20,000)</label>
            <label><input type="radio" name="paymethod" value="pix" /> Pix (BRL 30,00)</label>
            <label><input type="radio" name="paymethod" value="zelle" /> Zelle (USD 5)</label>
          </div>
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end;">
          <button id="cancelPayer" class="btn secondary">Cancel</button>
          <button id="confirmPayer" class="btn">Reserve & Continue</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Modal (QR/instructions + countdown) -->
  <div id="payModal" class="modal hidden">
    <div class="modal-content">
      <span id="payClose" class="close">×</span>
      <h2 id="payTitle">Complete your payment</h2>
      <div id="payBody"></div>
      <div id="countdown" class="countdown"></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // --- Elements ---
    const gridEl = document.getElementById('grid');
    const selectedListEl = document.getElementById('selectedList');
    const clearSelectionBtn = document.getElementById('clearSelectionBtn');
    const choosePayBtn = document.getElementById('choosePayBtn');

    const payerModal = document.getElementById('payerModal');
    const payerClose = document.getElementById('payerClose');
    const payerNums = document.getElementById('payerNums');
    const firstNameEl = document.getElementById('firstName');
    const lastNameEl = document.getElementById('lastName');
    const emailEl = document.getElementById('email');
    const cancelPayerBtn = document.getElementById('cancelPayer');
    const confirmPayerBtn = document.getElementById('confirmPayer');

    const payModal = document.getElementById('payModal');
    const payClose = document.getElementById('payClose');
    const payTitle = document.getElementById('payTitle');
    const payBody = document.getElementById('payBody');
    const countdownEl = document.getElementById('countdown');

    // --- State ---
    const socket = io();
    let statusMap = new Map(); // number -> status ('available'|'reserved'|'sold')
    let selected = new Set();
    let countdownTimer = null;

    function fmt(n){ return n.toString().padStart(3, '0'); }

    function renderGrid() {
      gridEl.innerHTML = '';
      for (let i = 0; i <= 999; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.textContent = fmt(i);
        const s = statusMap.get(i) || 'available';
        cell.classList.toggle('reserved', s === 'reserved');
        cell.classList.toggle('sold', s === 'sold');
        cell.classList.toggle('selected', selected.has(i));
        if (s === 'available') {
          cell.addEventListener('click', () => toggleSelect(i));
        }
        gridEl.appendChild(cell);
      }
    }

    function updateSelectedList() {
      if (selected.size === 0) selectedListEl.textContent = 'None';
      else selectedListEl.textContent = Array.from(selected).sort((a,b)=>a-b).map(fmt).join(', ');
    }

    function toggleSelect(n) {
      if (statusMap.get(n) !== 'available') return;
      if (selected.has(n)) selected.delete(n); else selected.add(n);
      updateSelectedList();
      renderGrid();
    }

    async function loadNumbers() {
      const res = await fetch('/api/numbers');
      const data = await res.json();
      statusMap.clear();
      data.forEach(item => statusMap.set(item.number, item.status));
      renderGrid();
    }

    socket.on('numbers:update', (changed) => {
      changed.forEach(item => statusMap.set(item.number, item.status));
      renderGrid();
    });

    clearSelectionBtn.addEventListener('click', () => {
      selected.clear();
      updateSelectedList();
      renderGrid();
    });

    // Open payer modal (choose method + enter name/email)
    choosePayBtn.addEventListener('click', () => {
      if (selected.size === 0) { alert('Select at least one number.'); return; }
      payerNums.textContent = Array.from(selected).sort((a,b)=>a-b).map(fmt).join(', ');
      payerModal.classList.remove('hidden');
    });
    payerClose.addEventListener('click', () => payerModal.classList.add('hidden'));
    cancelPayerBtn.addEventListener('click', () => payerModal.classList.add('hidden'));

    confirmPayerBtn.addEventListener('click', async () => {
      const firstName = (firstNameEl.value || '').trim();
      const lastName = (lastNameEl.value || '').trim();
      const email = (emailEl.value || '').trim();

      if (!firstName || !lastName || !email) {
        alert('Please fill First Name, Last Name, and Email.');
        return;
      }
      const payMethod = document.querySelector('input[name="paymethod"]:checked').value;
      const nums = Array.from(selected);

      const res = await fetch('/api/reserve', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          numbers: nums,
          paymentMethod: payMethod,
          buyer: { firstName, lastName, email }
        })
      });

      const data = await res.json();
      if (!res.ok) {
        if (data.unavailable) alert('Some numbers are no longer available: ' + data.unavailable.join(', '));
        else alert(data.error || 'Reservation failed');
        await loadNumbers();
        selected.clear();
        updateSelectedList();
        payerModal.classList.add('hidden');
        return;
      }

      // Success: show payment modal
      selected.clear();
      updateSelectedList();
      payerModal.classList.add('hidden');
      openPaymentModal(data);
    });

    // Payment modal & countdown
    function openPaymentModal({ reservationId, expiresAt, reserved, payment }) {
      payModal.classList.remove('hidden');
      payTitle.textContent = `Reservation ${reservationId.slice(0,8)}…`;
      const list = reserved.join(', ');

      if (payment.provider === 'nequi' || payment.provider === 'pix') {
        payBody.innerHTML = `
          <div class="qrBox">
            <div><strong>Scan to pay (${payment.provider.toUpperCase()})</strong></div>
            <div style="font-size:12px; margin-top:6px;">(Demo QR string shown)</div>
            <div style="word-wrap:break-word; margin-top:8px;">${payment.qrData}</div>
          </div>
          <div class="kv">
            <div>Numbers:</div><div>${list}</div>
            <div>Amount:</div><div>${payment.amount} ${payment.currency}</div>
            <div>Confirm:</div><div>In production, the provider webhook confirms automatically.</div>
          </div>
          <button id="demoPaidBtn" class="btn">Mark as Paid (demo)</button>
          <div class="note">Demo button simulates payment confirmation.</div>
        `;
        document.getElementById('demoPaidBtn').onclick = async () => {
          await fetch('/api/reservations/test-pay', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reservationId })
          });
          closePayModal();
        };
      } else if (payment.provider === 'zelle') {
        payBody.innerHTML = `
          <div class="kv">
            <div>Numbers:</div><div>${list}</div>
            <div>Send to:</div><div>${payment.instructions.recipient}</div>
            <div>Amount:</div><div>${payment.amount} ${payment.currency}</div>
            <div>Memo:</div><div>${payment.instructions.memo}</div>
          </div>
          <div class="note">After sending via Zelle, an admin must confirm your payment.</div>
        `;
      }

      startCountdown(expiresAt);
    }

    function startCountdown(expiresAt) {
      if (countdownTimer) clearInterval(countdownTimer);
      function tick() {
        const ms = Math.max(0, expiresAt - Date.now());
        const m = Math.floor(ms / 60000);
        const s = Math.floor((ms % 60000) / 1000);
        countdownEl.textContent = `Time left: ${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        if (ms <= 0) {
          clearInterval(countdownTimer);
          countdownEl.textContent = 'Reservation expired';
        }
      }
      tick();
      countdownTimer = setInterval(tick, 500);
    }

    function closePayModal() {
      payModal.classList.add('hidden');
      payBody.innerHTML = '';
      countdownEl.textContent = '';
      if (countdownTimer) clearInterval(countdownTimer);
    }
    payClose.addEventListener('click', closePayModal);

    // init
    loadNumbers();
  </script>
</body>
</html>
